/**
 * signatures í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
 * ì‚¬ìš©ë²•: npx tsx scripts/migrate-signatures-schema.ts
 */

import { createClient } from '@supabase/supabase-js'

const SUPABASE_URL = 'https://titqtnobfapyjvairgqy.supabase.co'
const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpdHF0bm9iZmFweWp2YWlyZ3F5Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODc5NDQyNSwiZXhwIjoyMDg0MzcwNDI1fQ.M6mlPiqgRruYCd4jXBcIOsYIhtqgvJmGmzg6l3KakwU'

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
  auth: { persistSession: false }
})

async function checkCurrentSchema() {
  console.log('ğŸ“‹ í˜„ì¬ signatures í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¸...')

  // ë¹ˆ ë°ì´í„° í•˜ë‚˜ selectí•´ì„œ ì»¬ëŸ¼ í™•ì¸
  const { data, error } = await supabase
    .from('signatures')
    .select('*')
    .limit(1)

  if (error) {
    console.log('âŒ í…Œì´ë¸” ì¡°íšŒ ì‹¤íŒ¨:', error.message)
    return null
  }

  // ì»¬ëŸ¼ ëª©ë¡ í™•ì¸ì„ ìœ„í•´ ì „ì²´ í…Œì´ë¸” ì •ë³´ ì¡°íšŒ
  console.log('í˜„ì¬ ë°ì´í„° ìƒ˜í”Œ:', data)
  return data
}

async function main() {
  console.log('ğŸš€ signatures í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜')
  console.log('')

  await checkCurrentSchema()

  // ë°©ë²•: RPCë¥¼ í†µí•´ SQL ì‹¤í–‰ (exec_sql í•¨ìˆ˜ê°€ ìˆì–´ì•¼ í•¨)
  // ë˜ëŠ”: Supabase Dashboardì—ì„œ ì§ì ‘ SQL ì‹¤í–‰

  console.log('')
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log('ğŸ“ ë‹¤ìŒ SQLì„ Supabase SQL Editorì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”:')
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log(`
-- 1. ê¸°ì¡´ í…Œì´ë¸” ë°±ì—…
CREATE TABLE IF NOT EXISTS signatures_backup AS SELECT * FROM signatures;

-- 2. ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ
DROP TABLE IF EXISTS public.signatures CASCADE;

-- 3. ìƒˆ signatures í…Œì´ë¸” ìƒì„±
CREATE TABLE public.signatures (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  sig_number integer NOT NULL,
  title text NOT NULL,
  description text,
  thumbnail_url text,
  unit public.org_unit NOT NULL DEFAULT 'excel',
  created_at timestamptz DEFAULT now() NOT NULL,
  CONSTRAINT signatures_unit_sig_number_unique UNIQUE (unit, sig_number)
);

-- 4. RLS ì„¤ì •
ALTER TABLE public.signatures ENABLE ROW LEVEL SECURITY;

CREATE POLICY "signatures_read_all" ON public.signatures
  FOR SELECT USING (true);

CREATE POLICY "signatures_insert_admin" ON public.signatures
  FOR INSERT TO authenticated
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- 5. ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_signatures_unit ON public.signatures(unit);
CREATE INDEX idx_signatures_sig_number ON public.signatures(sig_number);
`)
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
}

main().catch(console.error)
